# EC2 インスタンスのポート設定

## 概要

このドキュメントでは、SRE エージェントインフラストラクチャの EC2 インスタンスに必要なポート設定について説明します。すべてのサーバーは、安全な通信とデータ保護を確保するために SSL 暗号化を使用します。

## 必要なインバウンドポート

### HTTPS トラフィック
- **ポート 443（HTTPS）**: プライマリセキュア Web トラフィック
  - プロトコル: TCP
  - ソース: 0.0.0.0/0（インターネットに公開）
  - 目的: セキュアな Web インターフェースと API エンドポイント

### アプリケーションポート
- **ポート 8011-8014（カスタムアプリケーション）**: アプリケーション固有のサービス
  - プロトコル: TCP
  - ソース: 0.0.0.0/0（インターネットに公開）
  - 目的: 内部サービス通信とアプリケーションエンドポイント

## AWS セキュリティグループのベストプラクティス

### インバウンドルールの設定
- 攻撃対象領域を最小化するために必要なポートのみを許可
- 設定されたすべてのポートはインターネットトラフィック（0.0.0.0/0）に公開
- 異なるサービス層に対して別々のセキュリティグループを実装
- 保護のためにアプリケーションレベルのセキュリティと SSL/TLS に依存

### SSL/TLS 保護
- 設定されたポート上のすべてのサービスは SSL/TLS 暗号化を使用
- 証明書は AWS Certificate Manager（ACM）で管理する必要がある
- ポート 443 の Web トラフィックに対して HTTPS リダイレクトを強制

### セキュリティの推奨事項
- 定期的なセキュリティグループの監査とレビュー
- セキュリティグループには説明的な名前とタグを使用
- 最小権限アクセスの原則を実装
- トラフィックパターンと異常なアクセス試行を監視
- 追加の Web アプリケーション保護のために AWS WAF の使用を検討

### 本番環境のセキュリティ強化

本番環境では、すべてのインターネットトラフィック（0.0.0.0/0）を許可する代わりに、AWS IP アドレス範囲にアクセスを制限することでセキュリティを強化できます：

**AWS IP 範囲のダウンロード:**
```bash
curl -O https://ip-ranges.amazonaws.com/ip-ranges.json
```

[AWS IP アドレス範囲](https://docs.aws.amazon.com/vpc/latest/userguide/aws-ip-ranges.html) を使用して以下が可能です：
- AWS サービスからのトラフィックを識別
- 特定の AWS リージョンからのトラフィックのみを許可
- より良いセキュリティのために出力フィルタリングを実装
- 自動更新のために AWS マネージドプレフィックスリストを使用

**セキュリティグループ設定の例:**
`0.0.0.0/0` の代わりに、以下を指定できます：
- JSON ファイルからの AWS サービス IP 範囲
- 特定の会社/顧客の IP 範囲
- 内部通信用の VPC CIDR ブロック
- ロードバランサーのサブネット範囲

## ポート使用の概要

| ポート | プロトコル | 目的 | SSL 必須 |
|------|----------|---------|--------------|
| 443  | TCP      | HTTPS Web トラフィック | はい |
| 8011 | TCP      | アプリケーションサービス | はい |
| 8012 | TCP      | アプリケーションサービス | はい |
| 8013 | TCP      | アプリケーションサービス | はい |
| 8014 | TCP      | アプリケーションサービス | はい |

## コンプライアンスに関する注意事項

- 設定されたすべてのポートは SSL/TLS 暗号化を強制
- 定期的なセキュリティ評価にはポート設定のレビューを含める必要がある
- セキュリティ分析のために設定されたポート上のすべてのトラフィックを監視およびログに記録
