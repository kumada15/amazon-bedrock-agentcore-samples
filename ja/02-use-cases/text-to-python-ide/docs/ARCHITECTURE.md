# アーキテクチャ概要

## システムアーキテクチャ

AgentCore コードインタープリターは、モダンな 3 層アーキテクチャに従います:

```
┌─────────────────────────────────────────────────────────────────┐
│                     プレゼンテーション層                         │
│                    フロントエンド（React + AWS Cloudscape）      │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
│  │ コードジェネレー │ │  コードエディ   │ │   実行結果      │   │
│  │     ター タブ    │ │    ター タブ    │ │      タブ       │   │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘   │
└─────────────────────────────┬───────────────────────────────────┘
                              │ HTTP/WebSocket
┌─────────────────────────────┴───────────────────────────────────┐
│                     アプリケーション層                          │
│                    バックエンド（FastAPI + Strands-Agents）     │
│  ┌─────────────────┐                    ┌─────────────────┐     │
│  │ コードジェネレー │                    │ コードエグゼ    │     │
│  │  ター エージェント│                    │ キューター      │     │
│  │ (Strands-Agents)│                    │ (Strands-Agents)│     │
│  └─────────┬───────┘                    └─────────┬───────┘     │
└────────────┼────────────────────────────────────────┼───────────┘
             │                                        │
┌────────────┴────────────────────────────────────────┴───────────┐
│                      サービス層                                  │
│                     AWS Bedrock サービス                         │
│  ┌─────────────────┐                    ┌─────────────────┐     │
│  │ Claude Sonnet3.7│                    │   AgentCore     │     │
│  │ (推論プロファイ │                    │ CodeInterpreter │     │
│  │  ル)            │                    │   （サンドボックス）│     │
│  └─────────────────┘                    └─────────────────┘     │
│  ┌─────────────────┐                                            │
│  │  Nova Premier   │                                            │
│  │ (推論プロファイ │                                            │
│  │  ル)            │                                            │
│  └─────────────────┘                                            │
└─────────────────────────────────────────────────────────────────┘
```

## コンポーネントの詳細

### フロントエンド層（React）
- **技術**: React 18 + AWS Cloudscape デザインシステム
- **目的**: コード生成と実行のためのユーザーインターフェース
- **コンポーネント**:
  - コードジェネレーター: 自然言語入力と AI コード生成
  - コードエディター: Monaco ベースの Python コードエディター
  - 実行結果: エラー処理を含むフォーマット済み出力表示
- **通信**: HTTP REST API とリアルタイム更新用の WebSocket

### バックエンド層（FastAPI）
- **技術**: FastAPI + Strands-Agents フレームワーク
- **目的**: ビジネスロジックと AI エージェントオーケストレーション
- **コンポーネント**:
  - **コードジェネレーターエージェント**: 自然言語を Python コードに変換
  - **コードエグゼキューターエージェント**: Python コードを安全に実行
  - **セッションマネージャー**: ユーザーセッションと会話履歴を処理
  - **API ゲートウェイ**: RESTful エンドポイントと WebSocket ハンドラー
- **機能**:
  - インテリジェントなモデルフォールバック
  - セッション永続化
  - エラー処理とログ

### サービス層（AWS Bedrock）
- **技術**: AWS Bedrock + AgentCore
- **目的**: AI モデル推論とコード実行
- **コンポーネント**:
  - **Claude Haiku 4.5**: プライマリ AI モデル（推論プロファイル）
  - **Nova Premier**: フォールバック AI モデル（推論プロファイル）
  - **Claude 3.5 Sonnet**: セーフティネットモデル
  - **AgentCore**: サンドボックス化された Python 実行環境

## データフロー

### コード生成フロー
```
ユーザー入力 → フロントエンド → バックエンド API → Strands エージェント → Bedrock モデル → レスポンス
    ↓
生成されたコード → コードエディター → 実行準備完了
```

### コード実行フロー
```
Python コード → バックエンド API → Strands エージェント → AgentCore サンドボックス → 実行結果
    ↓
結果 → フロントエンド → フォーマット済み表示
```

## 主要な設計原則

### 1. **関心事の分離**
- フロントエンドは UI/UX のみを処理
- バックエンドがビジネスロジックを管理
- AWS サービスが AI と実行機能を提供

### 2. **フォールトトレランス**
- 複数の AI モデルフォールバック
- 優雅なエラー処理
- セッション復旧メカニズム

### 3. **セキュリティ**
- サンドボックス化されたコード実行
- AWS IAM ベースのアクセス制御
- 入力検証とサニタイズ

### 4. **スケーラビリティ**
- ステートレスなバックエンド設計
- クラウドネイティブサービス
- 水平スケーリング機能

### 5. **拡張性**
- プラグインベースのエージェントアーキテクチャ
- 設定可能なモデル選択
- モジュラーコンポーネント設計

## テクノロジースタック

| 層 | 技術 | 目的 |
|-------|------------|---------|
| **フロントエンド** | React 18 | ユーザーインターフェースフレームワーク |
| | AWS Cloudscape | デザインシステムとコンポーネント |
| | Monaco Editor | コード編集機能 |
| **バックエンド** | FastAPI | 高性能 API フレームワーク |
| | Strands-Agents | AI エージェントオーケストレーション |
| | Python 3.8+ | ランタイム環境 |
| **AI サービス** | AWS Bedrock | AI モデルホスティング |
| | Claude Haiku 4.5 | プライマリ言語モデル |
| | Nova Premier | フォールバック言語モデル |
| **実行** | AgentCore | サンドボックス化されたコード実行 |
| **インフラストラクチャ** | AWS | クラウドプラットフォーム |

## セキュリティアーキテクチャ

### 認証と認可
- AWS IAM ロールとポリシー
- プロファイルベースまたはアクセスキー認証
- 最小権限アクセスの原則

### コード実行セキュリティ
- 分離されたサンドボックス環境
- リソース制限とタイムアウト
- ネットワーク分離
- 永続ストレージへのアクセスなし

### データ保護
- 暗号化された通信（HTTPS/WSS）
- 機密データのログなし
- セッションベースのデータ分離

## デプロイメントアーキテクチャ

### 開発環境
```
ローカルマシン
├── フロントエンド（localhost:3000）
├── バックエンド（localhost:8000）
└── AWS サービス（リモート）
```

### 本番環境
```
AWS クラウド
├── フロントエンド（S3 + CloudFront）
├── バックエンド（ECS/Lambda）
├── ロードバランサー（ALB）
└── Bedrock サービス
```

## パフォーマンスに関する考慮事項

### 最適化戦略
- **モデルキャッシング**: 初期化されたモデルの再利用
- **コネクションプーリング**: 効率的な AWS サービス接続
- **非同期処理**: ノンブロッキング I/O 操作
- **レスポンスストリーミング**: リアルタイム結果配信

### 監視と可観測性
- ヘルスチェックエンドポイント
- 包括的なログ
- エラー追跡とアラート
- パフォーマンスメトリクス収集

このアーキテクチャは、AI 駆動のコード生成と実行のための堅牢でスケーラブル、かつ安全なプラットフォームを提供します。
