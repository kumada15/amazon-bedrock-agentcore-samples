# エージェント機能ガイド - ショッピングフォーカス

## 概要

コンシェルジュエージェントシステムは、包括的なショッピング支援と購入管理を提供するために連携する3つの専門エージェントで構成されています：

1. **Supervisor Agent** - すべてのインタラクションを調整するメインオーケストレーター
2. **Shopping Assistant** - 商品検索とレコメンデーションを処理
3. **Cart Manager** - ショッピングカート、決済、購入フローを管理

---

## 🎯 Supervisor Agent

### 役割
Supervisor Agent は、すべてのユーザーインタラクションのメインエントリポイントです。会話をオーケストレーションし、AgentCore Gateway 経由で専門エージェントにタスクを委任します。

### コア機能

#### 1. 会話オーケストレーション
- ユーザーリクエストを適切な専門エージェントにルーティング
- セッション間で会話コンテキストとメモリを維持
- サブエージェントからのレスポンスをフォーマットしてユーザーに提示
- コンテキスト認識を伴うマルチターン会話を処理

#### 2. Gateway 通信
- AgentCore Gateway 経由で専門エージェントと通信
- ユーザーコンテキスト（user_id、session_id）をすべてのサブエージェントに渡す
- サブエージェントからのストリーミングレスポンスを処理
- 分散サービス間でのツール呼び出しを管理

### 連携の仕組み
1. ユーザーが Supervisor にメッセージを送信
2. Supervisor が意図を分析し、Gateway 経由で適切なエージェントにルーティング
3. 専門エージェントがリクエストを処理し結果を返す
4. Supervisor がレスポンスをフォーマットしてユーザーに提示

---

## 🛍️ Shopping Assistant

### 役割
Shopping Assistant は、商品発見、レコメンデーション、パッキングリスト生成に特化しています。ユーザーが商品を見つけ、ショッピングニーズを整理するのを支援します。

### ツールと機能

#### 1. 商品検索
**`single_productsearch(user_id, question)`**
- ユーザークエリに基づいて商品を検索
- Product Advertising API（PaAPI）と統合して実際の商品データを取得
- ASIN 付きの商品レコメンデーションを返す
- 価格とレビューを含む詳細な商品情報を提供

**ユースケース：**
- 「100ドル以下のワイヤレスヘッドフォンを探して」
- 「マラソントレーニングに最適なランニングシューズを見せて」
- 「動画編集用のノートパソコンが必要」
- 「評価の高いコーヒーメーカーは？」

**パラメータ：**
- `user_id`: パーソナライズされた結果のためのユーザー識別子
- `question`: 自然言語の商品検索クエリ

**返り値：**
```json
{
  "answer": "100ドル以下のトップワイヤレスヘッドフォンはこちら...",
  "asins": ["B08ASIN123", "B08ASIN456", "B08ASIN789"]
}
```

**現在のステータス：**
> ⚠️ **注意**: 商品検索には Product Advertising API（PaAPI）統合が必要です。現在はプレースホルダーレスポンスを返し、商品調査にはインターネット検索を使用するよう案内しています。

#### 2. パッキングリスト生成
**`generate_packinglist_with_productASINS(user_id, question)`**
- 旅行やイベント用の包括的なパッキングリストを生成
- 各パッキングリストアイテムに特定の商品を推奨
- カートへの追加を容易にするために商品 ASIN を返す
- カテゴリ別にアイテムを整理（衣類、電子機器、トイレタリーなど）

**ユースケース：**
- 「ハワイで1週間過ごすためのパッキングリストを作成して」
- 「ニューヨークへの出張に何を持っていけばいい？」
- 「商品おすすめ付きのキャンプパッキングリストが必要」
- 「スキーバケーションの荷造りを手伝って」

**パラメータ：**
- `user_id`: パーソナライズされたレコメンデーションのためのユーザー識別子
- `question`: 自然言語のパッキングリストリクエスト

**返り値：**
```json
{
  "packing_list": {
    "clothing": [
      {"item": "水着", "asin": "B08SWIM123"},
      {"item": "サングラス", "asin": "B08SUN456"}
    ],
    "electronics": [
      {"item": "電話充電器", "asin": "B08CHRG789"}
    ],
    "toiletries": [
      {"item": "日焼け止め SPF 50", "asin": "B08SUN999"}
    ]
  }
}
```

**現在のステータス：**
> ⚠️ **注意**: パッキングリスト生成には Product Advertising API（PaAPI）統合が必要です。現在はプレースホルダーレスポンスを返します。

### インターネット検索との統合

PaAPI 統合が保留中の間、Shopping Assistant はインターネット検索エージェントと連携して商品調査を提供します：

**ワークフロー：**
1. ユーザーが「最高のワイヤレスヘッドフォンを探して」と尋ねる
2. Shopping Assistant が商品検索の意図を認識
3. Supervisor がウェブ調査のためにインターネット検索エージェントにルーティング
4. インターネット検索が記事、レビュー、おすすめを返す
5. ユーザーが商品名を使用して手動でカートに商品を追加可能

### 将来の拡張機能

PaAPI が統合されると、Shopping Assistant は以下が可能になります：
- 価格、評価、在庫状況を含む実際の商品データを返す
- ASIN を使用した直接「カートに追加」機能を提供
- 商品画像と詳細な仕様を表示
- 複数の販売者間で価格を比較
- 価格履歴とお得な情報アラートを追跡
- ユーザーの好みに基づいてパーソナライズされたレコメンデーションを提供

---

## 🛒 Cart Manager

### 役割
Cart Manager は、すべてのショッピングカート操作、決済処理、購入フローを処理します。安全な決済トークン化のために Visa と統合し、完全なチェックアウト体験を管理します。

### ツールと機能

#### 1. カート表示
**`get_cart(user_id)`**
- ユーザーのショッピングカート内のすべてのアイテムを取得
- 完全な詳細付きで商品を返す
- 価格、レビュー、商品 URL を含む

**返り値：**
```json
[
  {
    "asin": "B09XM5ASIN",
    "title": "Sony WH-1000XM5 ヘッドフォン",
    "price": "$399.99",
    "qty": 1,
    "reviews": "4.8/5 (12,450 件のレビュー)",
    "url": "https://amazon.com/..."
  },
  {
    "asin": "B09AIRPODS",
    "title": "Apple AirPods Pro",
    "price": "$249.99",
    "qty": 1,
    "reviews": "4.7/5 (89,234 件のレビュー)"
  }
]
```

#### 2. カートへのアイテム追加

**`add_to_cart(user_id, items)`**
- 商品をショッピングカートに追加
- ASIN、タイトル、価格が必要
- オプション：レビュー、商品詳細の URL
- 複数アイテムの一括追加をサポート

**例：**
```json
[
  {
    "asin": "B09XM5ASIN",
    "title": "Sony WH-1000XM5 ヘッドフォン",
    "price": "$399.99",
    "reviews": "4.8/5",
    "url": "https://amazon.com/sony-headphones"
  },
  {
    "asin": "B09AIRPODS",
    "title": "Apple AirPods Pro",
    "price": "$249.99",
    "reviews": "4.7/5"
  }
]
```

#### 3. アイテムの削除
**`remove_from_cart(user_id, asins)`**
- ASIN でカートから商品を削除
- 複数アイテムの一括削除をサポート
- 削除されたアイテムの数を返す

**ユースケース：**
- 「カートから Sony ヘッドフォンを削除して」
- 「カートのすべてのアイテムを削除して」
- 「AirPods を削除して」

#### 4. 購入フロー

**ステップ 1：確認のリクエスト**
**`request_purchase_confirmation(user_id)`**
- 合計金額を含む購入サマリーを準備
- ユーザーの支払いカード情報を取得
- すべてのカートアイテムから合計を計算
- ユーザー確認が必要なサマリーを返す

**返り値：**
```json
{
  "requires_confirmation": true,
  "total_amount": 649.98,
  "total_items": 2,
  "payment_method": "Visa 下4桁 1234",
  "items": [
    {"title": "Sony ヘッドフォン", "price": 399.99},
    {"title": "Apple AirPods", "price": 249.99}
  ],
  "message": "2アイテム、$649.98 で購入準備完了..."
}
```

**ステップ 2：購入の確認**
**`confirm_purchase(user_id)`**
- ユーザー確認後に購入を実行
- Visa トークン化経由で決済を処理
- 一意の注文 ID を生成
- 購入成功後にカートをクリア
- 注文確認を返す

**返り値：**
```json
{
  "success": true,
  "order_id": "ORD-20251126-ABC123",
  "total_amount": 649.98,
  "items_count": 2,
  "payment_method": "Visa 下4桁 1234",
  "message": "購入が完了しました！"
}
```

**ステップ 3：確認メールの送信**
**`send_purchase_confirmation_email(order_id, recipient_email, total_amount, items_count, payment_method)`**
- AWS SES 経由で購入確認を送信
- 注文詳細と領収書を含む
- プロフェッショナルな HTML メールテンプレート
- 追跡用のメッセージ ID を返す

#### 5. 支払いカード管理

**`onboard_card(user_id, card_number, expiration_date, cvv, card_type, is_primary)`**
- 新しい支払いカードを安全にオンボード
- Visa トークン化と統合
- 暗号化されたトークンをユーザープロファイルに保存
- プライマリカードとバックアップカードをサポート
- 将来のトランザクション用に vProvisionedTokenId を返す

**セキュリティ機能：**
- カード番号は Visa 経由でトークン化
- 下4桁のみ保存
- CVV は永続化されない
- 暗号化されたトークンを決済に使用

**`get_visa_iframe_config(user_id)`**
- Visa iframe 統合用の設定を提供
- セキュアな iframe URL と設定を返す
- カードオンボーディングフロー用に UI で使用
- PCI コンプライアンスを確保

---

## 🔄 エージェントの連携

### 例：完全なショッピングフロー

**ユーザーリクエスト：** 「仕事用のワイヤレスヘッドフォンとノートパソコンバッグが必要」

#### フェーズ 1：商品発見（Supervisor → Shopping Assistant）
1. **Supervisor** がリクエストを受信し、Gateway 経由で Shopping Assistant にルーティング
2. **Shopping Assistant** が実行：
   - `single_productsearch("仕事用ワイヤレスヘッドフォン")` - ヘッドフォンを検索
   - `single_productsearch("プロフェッショナルノートパソコンバッグ")` - バッグを検索
3. **Shopping Assistant** が ASIN 付きの商品レコメンデーションを返す
4. **Supervisor** がユーザーにオプションを提示

#### フェーズ 2：カートに追加（Supervisor → Cart Manager）
5. ユーザーが言う：「Sony ヘッドフォンとレザーノートパソコンバッグを追加して」
6. **Supervisor** が Gateway 経由で Cart Manager にルーティング
7. **Cart Manager** が実行：
   - `add_to_cart()` - 選択した両方の商品を追加
8. **Supervisor** がアイテム追加を確認

#### フェーズ 3：カート確認（Supervisor → Cart Manager）
9. ユーザーが言う：「カートを見せて」
10. **Cart Manager** が実行：
    - `get_cart()` - すべてのカートアイテムを取得
11. **Supervisor** が合計付きでカートを表示

#### フェーズ 4：購入（Supervisor → Cart Manager）
12. ユーザーが言う：「チェックアウトする準備ができた」
13. **Cart Manager** が実行：
    - `request_purchase_confirmation()` - サマリーを表示
14. **Supervisor** がサマリーをユーザーに提示
15. ユーザーが購入を確認
16. **Cart Manager** が実行：
    - `confirm_purchase()` - 決済を処理
    - `send_purchase_confirmation_email()` - 領収書を送信
17. **Supervisor** が購入成功を確認

---

## 🔑 主要統合ポイント

### 1. ユーザーコンテキストフロー
- **Supervisor** が user_id と session_id を維持
- すべてのツール呼び出しにパーソナライゼーション用の user_id を含む
- セッションコンテキストがエージェント境界を越えて保持
- メモリが AgentCore Memory サービス経由で共有

### 2. データ引き渡し
- **Shopping Assistant** → **Supervisor**：ASIN 付きの商品レコメンデーション
- **Supervisor** → **Cart Manager**：購入用の選択されたアイテム
- **Cart Manager** → **Supervisor**：購入確認
- すべてのデータが一貫性のために Supervisor を通じて流れる

### 3. エラー処理
- 各エージェントが入力を検証し、構造化されたエラーを返す
- Supervisor がエラーを適切に処理し、ユーザーに通知
- 失敗した操作がカートの状態を破損しない
- 一時的な障害に対するリトライロジック

### 4. 状態管理
- **ショッピングリスト**：Supervisor 経由で DynamoDB に保存
- **カート**：Cart Manager 経由で DynamoDB に保存
- **ユーザープロファイル**：DynamoDB に保存（支払いカード、設定）
- **会話**：AgentCore Memory に保存

---

## 🎯 ベストプラクティス

### ショッピング支援用：
1. より良い結果のために具体的な商品クエリを使用
2. 検索に価格帯と好みを含める
3. 商品推奨を得るために旅行用パッキングリストを生成
4. カートに追加する前に商品詳細を確認

### カート管理用：
1. ユーザーが選択したらアイテムをカートに追加
2. 確定前に `request_purchase_confirmation()` を使用
3. 購入成功後は常に確認メールを送信
4. 購入成功後のみカートをクリア

### Supervisor オーケストレーション用：
1. 商品検索を Shopping Assistant にルーティング
2. カート操作を Cart Manager にルーティング
3. エージェント呼び出し間で会話コンテキストを維持
4. ユーザーフレンドリーな表示のためにサブエージェントレスポンスをフォーマット
5. 役立つメッセージでエラーを適切に処理

---

## 📊 ツールサマリー

| エージェント | ツール数 | 主要機能 |
|-------|-----------|-------------------|
| **Supervisor** | 0 | 会話オーケストレーション、ルーティング |
| **Shopping Assistant** | 2 | 商品検索、パッキングリスト |
| **Cart Manager** | 8 | カート操作、決済、購入 |

**合計ツール**：10の専門ツールが連携して包括的なショッピング支援を提供。

---

## 🚀 アーキテクチャの利点

### マイクロサービス設計
- 各エージェントが独立してデプロイ可能
- エージェントが需要に応じてスケール
- 障害が特定のサービスに分離
- 新しい専門エージェントの追加が容易

### Gateway 通信
- 集中化されたルーティングと認証
- すべてのエージェントで一貫した API
- 組み込みのモニタリングとトレーシング
- セキュアなエージェント間通信

### 関心の分離
- **Supervisor**：会話と調整
- **Shopping Assistant**：商品発見のドメイン専門知識
- **Cart Manager**：コマースと決済のドメイン専門知識
- 各エージェントが専門分野に集中

### 拡張性
- 新しい商品ソース（PaAPI、その他の API）の追加が容易
- 複数の決済プロバイダーと統合可能
- さまざまなショッピングシナリオをサポート（小売、イベント、ギフト）
- 新しい専門エージェントを追加するための柔軟なアーキテクチャ

---

## 🔮 将来の拡張機能

### Shopping Assistant
- **PaAPI 統合**：価格と在庫状況を含む実際の商品データ
- **価格比較**：複数の販売者間で価格を比較
- **お得情報アラート**：価格下落とセールをユーザーに通知
- **パーソナライゼーション**：時間をかけてユーザーの好みを学習
- **ビジュアル検索**：画像で商品を検索
- **レビュー分析**：商品レビューを要約

### Cart Manager
- **ウィッシュリスト管理**：後で購入するためにアイテムを保存
- **価格追跡**：カートアイテムの価格変動を監視
- **バンドルディール**：節約のための商品バンドルを提案
- **サブスクリプション管理**：定期購入を処理
- **ギフトオプション**：ギフトラッピングとメッセージを追加
- **複数の支払い方法**：分割払いをサポート

### 統合
- **ロイヤルティプログラム**：リワードポイントを追跡して適用
- **配送オプション**：配送方法とコストを比較
- **注文追跡**：リアルタイム配送追跡
- **返品管理**：返品と交換を処理
- **ソーシャルショッピング**：カートとレコメンデーションを共有

このアーキテクチャにより、責任の明確な分離を維持しながら複雑なマルチステップワークフローを処理できる、強力でスケーラブルで保守可能なショッピングアシスタントシステムが実現します。
