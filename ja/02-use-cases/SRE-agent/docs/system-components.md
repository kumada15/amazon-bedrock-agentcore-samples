# システムコンポーネント

SRE エージェントシステムは、スケーラブルで安全かつインテリジェントなインフラストラクチャ管理ソリューションを提供するために連携する 3 つのコア Amazon Bedrock AgentCore コンポーネントを基盤として構築されています。

## アーキテクチャ概要

```
┌──────────────────────────────────┐  ┌─────────────────────────────────────┐
│        AgentCore Memory          │  │         AgentCore Runtime           │
│  • ユーザー好み                   │  │  ┌──────────────────────────────────┐
│  • インフラストラクチャ知識        │  │  │   マルチエージェントシステム (LangGraph) │
│  • 調査サマリー                   │  │  │  ┌─────────────────┐             │
└─────────────┬────────────────────┘  │  │  │   Supervisor    │             │
              │                       │  │  │     Agent       │             │
              └──────────────────────►│  │  └────────┬────────┘             │
                                      │  │           │                      │
                                      │  │  ┌────────┴────┬─────┬─────┬───┐ │
                                      │  │  ▼             ▼     ▼     ▼   ▼ │
                                      │  │┌──────┐  ┌──────┐ ┌─────┐ ┌───┐│ │
                                      │  ││ K8s  │  │ Logs │ │Metr-│ │Run││ │
                                      │  ││Agent │  │Agent │ │ics  │ │bks││ │
                                      │  │└───┬──┘  └──┬───┘ └──┬──┘ └─┬─┘│ │
                                      │  └────┼────────┼────────┼──────┼──┘ │
                                      └───────┼────────┼────────┼──────┼────┘
                                              │        │        │      │
                                              ▼        ▼        ▼      ▼
┌────────────────────────────────────────────────────────────────────────┐
│                        AgentCore Gateway                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐     │
│  │  MCP ツール  │  │    認証     │  │   API 変換                   │     │
│  └──────┬──────┘  └──────┬──────┘  └─────────┬───────────────────┘     │
└─────────┼────────────────┼───────────────────┼─────────────────────────┘
          │                │                   │
          ▼                ▼                   ▼
    バックエンド API   ID プロバイダー     OpenAPI 仕様
```

## マルチエージェントシステム

**LangGraph** を基盤として構築されたマルチエージェントシステムは、複雑な調査のために専門エージェントをオーケストレーションします。

### Supervisor エージェント
以下を行う中央コーディネーター：
- 受信クエリを分析し、調査戦略を決定
- 専門性に基づいてタスクを適切な専門エージェントにルーティング
- 複数ドメインにわたるマルチステップ調査を調整
- **すべてのメモリ操作を管理** - AgentCore Memory への直接アクセスは supervisor のみ
- 取得したユーザー好みと過去の調査に基づいて調査をパーソナライズ

### 専門エージェント
各エージェントは専用ツールを使用して特定のドメインに集中します：

#### Kubernetes インフラストラクチャエージェント
コンテナオーケストレーションとクラスター操作を担当。このエージェントは、クラスターの状態を調査し、Pod の健全性、リソース使用率、最近のイベントを分析することで、Pod、デプロイメント、サービス、ノード全体の問題を調査します。

**機能:**
- namespace 全体の Pod ステータスを確認
- デプロイメント設定とロールアウト履歴を調査
- 異常を検出するためのクラスターイベントを調査
- リソース使用パターンを分析
- ノードの健全性と容量を監視

#### アプリケーションログエージェント
関連情報を見つけるためにログデータを処理。このエージェントはログパターンを理解し、異常を特定し、複数のサービス間でイベントを相関させます。

**機能:**
- 正規表現サポート付きの全文検索
- エラーログの集約と分類
- 繰り返し発生する問題のパターン検出
- イベントの時間ベースの相関
- ログボリュームの統計分析

#### パフォーマンスメトリクスエージェント
システムメトリクスを監視し、パフォーマンスの問題を特定。このエージェントは異なるメトリクス間の関係を理解し、リアルタイム分析と履歴トレンドの両方を提供します。

**機能:**
- アプリケーションパフォーマンスメトリクス（応答時間、スループット）
- しきい値付きエラーレート分析
- リソース使用率メトリクス（CPU、メモリ、ディスク）
- 可用性とアップタイム監視
- キャパシティプランニングのためのトレンド分析

#### 運用ランブックエージェント
ドキュメント化された手順、トラブルシューティングガイド、ベストプラクティスへのアクセスを提供。このエージェントは、現在の状況に基づいて関連する手順を取得することで、インシデント対応を標準化するのに役立ちます。

**機能:**
- 一般的なシナリオ用のインシデント固有のプレイブック
- ステップバイステップの手順を含む詳細なトラブルシューティングガイド
- 連絡先情報付きのエスカレーション手順
- 既知の問題に対する一般的な解決パターン
- システム運用のベストプラクティス

#### 検索エージェント
クロスドメイン情報検索機能を提供：

**機能:**
- すべてのインフラストラクチャドメインにわたる統合検索
- コンテキスト認識型の結果ランキングとフィルタリング
- 異なるエージェントドメイン間の情報相互参照

### エージェントの協調
supervisor は以下によって複雑な調査を調整します：
1. クエリを専門タスクに分解
2. タスクを適切なエージェントに並列または順次でルーティング
3. 複数のエージェントからの結果を集約
4. 発見結果にメモリベースのパーソナライズを適用
5. 統一されたコンテキスト認識型レポートを生成

## Amazon Bedrock AgentCore

システムはエンタープライズグレードの AI インフラストラクチャを提供する 3 つの基本的な AgentCore プリミティブを活用します：

### 1. AgentCore Runtime
AI エージェント専用に設計された**サーバーレス実行環境**：

- **マネージドインフラストラクチャ**: ゼロから数千の同時セッションへの自動スケーリングを備えた完全マネージドコンピューティング
- **コンテナベースのデプロイメント**: 組み込みのセキュリティと分離を備えた ARM64 Docker コンテナをサポート
- **エンタープライズ統合**: セッションレベルのセキュリティ境界を持つネイティブ AWS IAM サポート
- **マルチモデルサポート**: Amazon Bedrock モデルと外部 LLM プロバイダーと互換
- **本番機能**: 組み込みのモニタリング、ロギング、デバッグ、オブザーバビリティ

### 2. AgentCore Gateway
エージェントがバックエンドシステムと対話できるようにする**安全な API ブリッジ**：

- **プロトコル変換**: REST/GraphQL/gRPC API を標準化された MCP（Model Context Protocol）ツールに変換
- **ユニバーサルツールインターフェース**: 任意のエージェントフレームワークがツールを検出して使用するための一貫したインターフェースを提供
- **エンタープライズセキュリティ**: 複数の ID プロバイダー（Cognito、Auth0、Okta）をサポートする JWT ベースの認証
- **API 管理**: 健全性監視、自動リトライ、レート制限、エラーハンドリング
- **スキーマ駆動**: OpenAPI 仕様を使用してツール定義を自動生成

### 3. AgentCore Memory
エージェントが時間とともに学習しパーソナライズできるようにする**永続的知識システム**：

- **イベントベースのストレージ**: データ損失なしに知識を蓄積する不変イベントログ
- **Namespace 分離**: ユーザーとコンテキストの分離のためのアクター ID に基づく自動ルーティング
- **柔軟な保持**: 異なるメモリタイプに対する設定可能な保持ポリシー（30-90 日）
- **パターン抽出**: 非構造化エージェントレスポンスからの構造化データの自動抽出
- **クロスセッション学習**: エージェントが過去の調査とユーザーインタラクションに基づいて構築できるように

## 統合アーキテクチャ

### データフロー
1. **ユーザークエリ** → Supervisor エージェントが分析し、関連するメモリを取得
2. **調査計画** → Supervisor が専門エージェントにルーティング
3. **ツール実行** → エージェントが Gateway を通じてバックエンド API にアクセス
4. **レスポンス処理** → メモリシステムがパターンを抽出して保存
5. **レポート生成** → ユーザー好みに基づくパーソナライズされたレポート

### セキュリティモデル
- **IAM 統合**: `BedrockAgentCoreFullAccess` ポリシーによる完全な AWS IAM サポート
- **JWT 認証**: ゲートウェイ通信用のベアラートークン
- **SSL/TLS 必須**: すべてのエンドポイントは HTTPS を使用する必要がある
- **Namespace 分離**: メモリイベントはアクター ID によって分離

## ツールドメイン

ゲートウェイは 4 つのドメインにわたって 20 の専門ツールを提供します：

### Kubernetes 操作（5 ツール）
- `get_pod_status`: Pod の健全性と状態を監視
- `get_deployment_status`: デプロイメントのロールアウトステータスを確認
- `get_cluster_events`: 最近のクラスターイベントを取得
- `get_resource_usage`: CPU/メモリ使用率を分析
- `get_node_status`: ノードの健全性と容量を監視

### ログ分析（5 ツール）
- `search_logs`: ログストリーム全体の全文検索
- `get_error_logs`: エラーと例外ログを抽出
- `analyze_log_patterns`: 繰り返しパターンを検出
- `get_recent_logs`: 最新のログエントリを取得
- `count_log_events`: ログイベント統計を集約

### メトリクス収集（5 ツール）
- `get_performance_metrics`: アプリケーションパフォーマンスデータ
- `get_error_rates`: エラーレートのトレンドとスパイク
- `get_resource_metrics`: インフラストラクチャリソース使用量
- `get_availability_metrics`: サービスアップタイムと SLA
- `analyze_trends`: 履歴トレンド分析

### ランブック管理（5 ツール）
- `search_runbooks`: 関連する手順を検索
- `get_incident_playbook`: インシデント対応ガイド
- `get_troubleshooting_guide`: ステップバイステップのデバッグ
- `get_escalation_procedures`: 連絡先とエスカレーションパス
- `get_common_resolutions`: 既知の問題の解決策

## デモ環境

評価とテストのために、システムには以下を含むデモ環境が含まれています：

- **モック API サーバー**: シミュレートされた Kubernetes、ログ、メトリクス、ランブック API
- **現実的なデータ**: 代表的なインフラストラクチャシナリオと障害パターン
- **安全なテスト**: 分離された環境で本番への影響を防止
- **フル機能サポート**: デモモードですべてのエージェント機能が利用可能

## 開発から本番へ

アーキテクチャは開発から本番へのシームレスな進行をサポートします：

```
ローカル開発 → コンテナテスト → 本番デプロイメント
     (CLI)          (Docker)        (AgentCore Runtime)
       ↓               ↓                    ↓
  Gateway のみ    Gateway + Runtime    Memory 付きフルスタック
```

この統一されたアプローチにより、すべてのデプロイメントステージで一貫した動作を保証しながら、エンタープライズ本番使用に必要なスケーラビリティとセキュリティを提供します。
