# Bedrock AgentCore Identity の仕組み

## はじめに

AgentCore Identity は、AIエージェントデプロイメントにおける基本的な課題に対処します：セキュリティやユーザーエクスペリエンスを損なうことなく、エージェントが複数のサービスにまたがるユーザー固有のデータに安全にアクセスできるようにすること。従来のアプローチでは、きめ細かい制御なしに広範なアクセス資格情報を使用するか、各サービス統合に対して明示的なユーザー同意を必要とするか（ユーザーエクスペリエンスの低下を招く）のいずれかでした。AgentCore Identity は、ゼロトラストセキュリティ原則と委任ベースの認証を実装する包括的なワークフローを通じてこれを解決します。

このサービスは**なりすましではなく委任**の原則に基づいて動作します。エージェントがユーザー資格情報を直接使用する代わりに、エージェントは検証可能なユーザーコンテキストを保持しながら自身として認証します。このアプローチにより、きめ細かなアクセス制御、包括的な監査証跡、およびユーザーアクセスとは独立してエージェントアクセスを取り消す機能が可能になります。このワークフローは、複数の信頼ドメインにまたがる複雑な認証と認可を調整しながら、開発者にシンプルなインターフェースを提供します。

AgentCore Identity の核心は、エージェントが適切なセキュリティ境界を維持しながらリソースにアクセスするための安全な認証メカニズムを提供することです。これにより、サービスは適切な認可決定を行うことができ、単一のワークフロー内で内部カレンダーシステムと Google カレンダーなどの外部サービスにアクセスできるクロスサービスエージェントのような高度なユースケースをサポートします。

以下の図は、ユーザー、アプリケーション、エージェント、AWSリソース、サードパーティサービスが安全に相互作用する方法を示す、完全な AgentCore Identity ワークフローを説明しています：

<div style="text-align:center">
    <img src="images/how_it_works.png" width="100%"/>
</div>

AgentCore Identity ワークフローは以下のステップで構成されます：

**ユーザーがOAuth/OIDCでサインインし、アプリケーションにトークンを渡す** — ユーザーは組織の既存のIDプロバイダー（Auth0、Cognito、またはその他のOIDC準拠システムなど）を通じて認証し、アクセストークンまたはIDトークンを受け取ります。このトークンにはユーザーのID情報と認可されたスコープが含まれており、ワークフロー全体でユーザーのIDコンテキストを確立します。アプリケーションはこのトークンを受け取り、エージェントへのリクエストを認可するために使用します。

**ユーザー向けアプリケーションがユーザーサインインを処理する** — アプリケーションはユーザーの認証トークンを検証し、安全なセッションを確立します。このステップにより、ユーザーが適切に認証され、AIエージェントを呼び出す機能を含むアプリケーションの機能にアクセスする権限があることを確認します。アプリケーションは、パーソナライゼーションとアクセス制御の目的でトークンからユーザーID情報を抽出することもあります。

**ユーザーがAIエージェントによるリソースアクセスを要求する** — ユーザーがエージェントとの対話を開始すると、アプリケーションはユーザーに代わってAIエージェントを呼び出すリクエストを行います。このリクエストには、ユーザーの認証トークンと、エージェントが達成する必要があることに関する必要なコンテキストが含まれます。アプリケーションはプロキシとして機能し、ユーザーのIDコンテキストを維持しながら、ユーザーの認証済みリクエストをエージェントインフラストラクチャに転送します。

**ユーザー向けアプリケーションがユーザートークンでエージェントサービスにリクエストを行う** — Bedrock AgentCore サービスはリクエストを受け取り、設定された認可ポリシーに対してユーザーのトークンを検証します。この検証には、トークンの署名、有効期限、発行者、オーディエンス、および必要なスコープのチェックが含まれます。サービスは、ユーザーが特定のエージェントを呼び出すために必要な権限を持ち、リクエストが続行する前にすべてのセキュリティ要件を満たしていることを確認します。

**Bedrock AgentCore がエージェント資格情報プロバイダーにワークロードアクセストークンを要求する** — エージェントサービスは、ワークロードアクセストークン（技術的にはワークロードアクセストークン）を取得するためのトークン交換プロセスを開始します。エージェントサービスは、ユーザーのトークンを AgentCore Identity のトークン交換APIに送信します。リクエストはIAM資格情報で認可されます。これにより、信頼のチェーンを維持し、認可決定をサポートしながら、ダウンストリームリソースへの安全で監査可能なアクセスが可能になります。

**AgentCore Identity がユーザートークンを検証し、ワークロードアクセストークンを発行する** — AgentCore Identity は、ユーザーのトークンの署名、有効期限、発行者、オーディエンス、およびスコープを検証します。その後、ワークロードアクセストークンを返します。これにより、信頼のチェーンを維持しながら、ダウンストリームリソースへの安全で監査可能なアクセスが可能になります。AgentCore Identity は、エージェントのIDの検証、ユーザーの元のOAuth/OIDCトークンの署名とクレームの検証、およびエージェントがユーザーに代わって要求されたリソースにアクセスする権限があることの確認を含む、リクエストの包括的なゼロトラスト検証を実行します。この検証は、ソースや以前の信頼関係に関係なく行われ、すべてのリクエストが独立して認証および認可されることを保証します。

**AIエージェントアプリケーションがエージェントを呼び出す** — エージェントアプリケーションはワークロードアクセストークンを受け取り、要求されたタスクの実行を開始します。エージェントは、自身のIDと代理で行動しているユーザーの両方の検証可能な証明を持って操作できるようになります。これにより、エージェントは元のユーザーへのアクションの完全な追跡可能性を維持しながら、さまざまなツールとリソースに認証済みリクエストを行うことができます。

**エージェントがリソースアクセストークンを要求する** — エージェントが AWS リソースやサードパーティサービス（Google カレンダー、Slack、または内部APIなど）にアクセスする必要がある場合、AgentCore 資格情報プロバイダーに適切な資格情報を要求します。エージェントは、自身のIDと認可の証明としてワークロードアクセストークンを提示します。システムはこのトークンを検証し、設定されたポリシーとユーザーの同意に基づいて、エージェントがアクセスを許可されているリソースを判断します。AgentCore Identity は、要求されたユーザーIDとリソースに対する既存のトークンを持っている場合があり、その場合はリソースアクセストークンを返します。

**Amazon Bedrock AgentCore Identity がリソースに対するユーザー認証を要求する** — AgentCore Identity がトークンボールトに要求されたリソースに対する既存のアクセストークンを持っていない場合、提供されたURLでユーザーの同意が必要であることを示す応答を返します。明示的なユーザーの同意を必要とするリソース（Google カレンダーなどのサードパーティサービス）の場合、システムはユーザー認証フローを開始する必要がある場合があります。これは通常、ユーザーをリソースプロバイダーの認可サーバー（Google の OAuth 2.0 エンドポイントや Microsoft の Azure AD など）にリダイレクトして、エージェントがデータにアクセスする許可を付与することを含みます。このステップにより、ユーザーはエージェントが自分に代わってアクセスできるリソースを制御でき、OAuth 2.0 クライアント資格情報グラント（マシン間）と OAuth 2.0 認可コードグラント（ユーザー委任アクセス）の両方のフローをサポートします。

**Bedrock AgentCore がユーザー認証を要求する** — エージェントサービスは、要求された認可URLを渡してユーザー向けアプリケーションに応答を返します。

**ユーザー向けアプリケーションが認証と同意プロンプトを表示する** — ユーザーは資格情報を入力し、エージェントとデータを共有することを求められます。

**ユーザーがデータ共有に同意する** — ユーザーはサードパーティプロバイダーからの同意プロンプトを受け入れます。

**サードパーティリソースがユーザー資格情報を検証し、リソースアクセストークンを発行する** — サードパーティサービスプロバイダー（Google、Microsoft、または Salesforce など）はユーザーの資格情報と同意を検証し、エージェントが使用するためのアクセストークンを発行します。このトークンは通常、最小権限アクセスの原則に従って、ユーザーがエージェントに明示的に付与した権限のみにスコープされます。この認可リクエストのコールバックURLは、プロバイダーの応答を処理し、要求されたリソースのアクセストークンを収集する AgentCore Identity サービスエンドポイントです。

**AgentCore Identity がリソースアクセストークンを保存して返す** — AgentCore Identity は、エージェントからのリクエストに応答してリソースアクセストークンを返します。サービスはまた、将来の使用のためにリソースアクセストークンをトークンボールトに安全に保存し、特定のエージェントIDとユーザーIDの組み合わせに関連付けます。これにより、後続のリクエストでユーザー認証を繰り返すことなくトークンを再利用でき、セキュリティを維持しながらユーザーエクスペリエンスを向上させます。トークンは暗号化され、不正な取得を防ぐためにアクセス制御されます。トークンボールトはゼロトラスト原則に基づいて動作し、資格情報が元々取得した正確なエージェントとユーザーの組み合わせによってのみアクセスできることを保証します。これにより、異なるエージェントやユーザー間の不正なクロスアクセスを防ぎます。

**エージェントがリソースからデータを要求する** — リソース固有のアクセストークンを使用して、エージェントはサードパーティリソースからデータを読み取りまたは書き込みするためのAPI呼び出しを行います。エージェントは、ユーザーによって付与された権限とリソースプロバイダーAPIによって定義された機能の範囲内で動作します。すべてのアクションは、監査とセキュリティの目的でエージェントのIDが明確に確立された状態で実行されます。

**サードパーティリソースがリソースアクセストークンを検証し、データを返す** — サードパーティサービスは、エージェントによって提供されたアクセストークンを検証し、それが有効で、期限切れでなく、要求された操作に必要なスコープを持っていることを確認します。検証が成功すると、リソースは要求されたデータを返すか、要求されたアクションの完了を確認します。この検証により、適切なユーザー同意を持つ認可されたエージェントのみが保護されたリソースにアクセスできることを保証します。

**AIエージェントアプリケーションが応答を組み立てる** — エージェントは AWS リソースとサードパーティサービスから受け取ったデータを処理し、追加のロジックとコンテキストと組み合わせて包括的な応答を作成します。エージェントはユーザーの元のリクエストに関するコンテキストを維持し、アクセスされたリソースからのデータを組み込みながら、応答がユーザーのニーズに対応することを保証します。

**AgentCore がアプリケーションに応答を返す** — エージェントは完成した応答をユーザー向けアプリケーションに送り返します。この応答には、エージェントのアクションの結果、AWS リソースおよびサードパーティサービスから取得したデータ、完了したタスクの確認が含まれます。応答はセキュリティコンテキストを維持し、ユーザーに代わって実行されたアクションに関する監査情報を提供します。

**ユーザー向けアプリケーションが応答を表示する** — アプリケーションは、テキスト、構造化データ、または完了したアクションの確認など、適切な形式でエージェントの応答をユーザーに提示します。ユーザーはリクエストの結果を確認し、エージェントがさまざまなリソースへの認可されたアクセスを使用して達成したことを理解できます。

**プロセス完了（Done）** — ワークフローは、すべてのトークンが適切に管理され、監査ログが記録され、ユーザーのリクエストが完了した状態で終了します。システムは、複数のサービスやプラットフォームにまたがるデータにアクセスして操作するためにAIエージェントを活用したいユーザーにシームレスなエクスペリエンスを提供しながら、プロセス全体を通じてセキュリティを維持します。

このワークフローは、従来の認証アプローチと AgentCore 資格情報プロバイダーを区別するいくつかの主要な技術原則に基づいて構築されています。このサービスは**ゼロトラストセキュリティ**を実装し、ソースや以前の信頼関係に関係なく、すべてのリクエストを検証します。なりすましではなく**委任ベースの認証**を使用し、エージェントがユーザーコンテキストを保持しながら常に自身として認証することを保証します。このサービスは**MCP（Model Context Protocol）準拠**であり、エージェントからツールへの通信の標準プロトコルをサポートしています。最後に、**クロスプラットフォームサポート**を提供し、一貫したセキュリティ標準を維持しながら、AWS、他のクラウドプロバイダー、およびオンプレミス環境でエージェントが動作できるようにします。
