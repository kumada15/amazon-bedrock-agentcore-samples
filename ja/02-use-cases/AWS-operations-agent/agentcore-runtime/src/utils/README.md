# AgentCore メモリ実装

このディレクトリには、Amazon Bedrock AgentCore Memory を使用した短期メモリ機能を実装する AgentCore エージェント用のメモリ管理ユーティリティが含まれています。

## 機能

- **短期メモリ**: 会話の流れを維持するための会話コンテキストを保存
- **セッション管理**: コンテキストの継続性のためにセッション ID で会話を追跡
- **マルチエージェントサポート**: DIY と SDK の両方のエージェント実装で動作
- **自動コンテキスト注入**: 以前の会話コンテキストをエージェントプロンプトにシームレスに追加
- **エラーハンドリング**: 欠落している依存関係やサービスエラーを適切に処理

## コンポーネント

### MemoryManager (`memory_manager.py`)

以下を提供するコアメモリ管理クラス：

- メモリリソースのセットアップと管理
- 会話ターンの保存と取得
- セッション追跡とコンテキストフォーマット
- Bedrock AgentCore Memory サービスとの統合

#### 主要メソッド

- `start_session(session_id)`: 新しい会話セッションを初期化
- `store_conversation_turn()`: ユーザー・エージェント間のやり取りをメモリに保存
- `get_conversation_context()`: 会話履歴を取得
- `format_context_for_agent()`: エージェント用にコンテキストをフォーマット
- `is_memory_available()`: メモリ機能がアクティブかどうかを確認

## 統合

### DIY エージェント統合

DIY エージェント（`src/agents/diy_agent.py`）は以下を通じてメモリを統合：

1. **自動コンテキスト注入**: 以前の会話コンテキストがユーザーメッセージの前に追加
2. **レスポンス収集**: エージェントのレスポンスがキャプチャされてメモリに保存
3. **セッション追跡**: 会話の継続性のためにリクエストペイロードの session_id を使用

### SDK エージェント統合

SDK エージェント（`src/agents/sdk_agent.py`）は同様のメモリ統合を含む：

1. **BedrockAgentCoreApp 統合**: メモリが SDK フレームワークと連携して動作
2. **ペイロード拡張**: リクエストペイロードで session_id と actor_id をサポート
3. **ストリーミングレスポンスキャプチャ**: メモリ保存のためにストリーミングレスポンスを収集

### チャットボットクライアント統合

チャットボットクライアント（`chatbot-client/src/client.py`）は以下を通じてメモリをサポート：

1. **セッション ID 生成**: 各ランタイム接続に一意のセッション ID を作成
2. **ペイロード拡張**: リクエストにセッションとアクター情報を含める
3. **メモリ統計**: デバッグ用の memory-stats コマンドを提供

## 設定

メモリ機能には以下が必要：

1. **依存関係**: `bedrock-agentcore` Python パッケージ
2. **AWS 設定**: 有効な AWS 認証情報とリージョン設定
3. **AgentCore 設定**: 適切な `agentcore-config.yaml` セットアップ

### 設定例

```yaml
aws:
  region: us-east-1
  account_id: '123456789012'

agents:
  payload_formats:
    diy: direct
    sdk: direct
```

## 使用方法

### 基本的な使用方法

以下の条件が満たされるとメモリが自動的に有効になります：
1. `bedrock-agentcore` パッケージがインストールされている
2. AWS 認証情報が設定されている
3. 指定されたリージョンでメモリサービスにアクセス可能

### メモリのテスト

チャットボットクライアントを使用してメモリ機能をテスト：

```bash
cd /path/to/chatbot-client
python src/client.py --interactive
```

利用可能なコマンド：
- `memory-stats`: メモリとセッション情報を表示
- `history`: ローカル会話履歴を表示
- `switch`: ランタイムを変更（新しいセッションを作成）

### メモリフロー

1. **セッション開始**: クライアントがランタイムに接続する際にセッション ID を生成
2. **コンテキスト取得**: エージェントがセッション ID を使用して以前の会話コンテキストを取得
3. **拡張プロンプト**: 以前のコンテキストが現在のユーザーメッセージの前に追加
4. **レスポンス生成**: エージェントが完全なコンテキストでレスポンスを生成
5. **メモリ保存**: ユーザーメッセージとエージェントレスポンスが将来のコンテキストのために保存

## エラーハンドリング

メモリ実装には包括的なエラーハンドリングが含まれます：

- **グレースフルデグラデーション**: メモリが利用できなくてもエージェントは正常に動作
- **警告メッセージ**: メモリ機能が無効な場合に明確な警告
- **依存関係チェック**: 必要なパッケージと設定を検証
- **サービス耐性**: メモリサービスが一時的に利用できなくても動作を継続

## モニタリング

メモリ使用量は以下を通じて監視可能：

1. **エージェントログ**: エージェントログ内のメモリ初期化とエラーメッセージ
2. **クライアントコマンド**: チャットボットクライアントの `memory-stats` コマンド
3. **AWS CloudWatch**: AgentCore Memory サービスのメトリクスとログ

## 制限事項

現在の実装は短期メモリのみを提供：

- **セッションスコープ**: メモリは個々のセッション期間に限定
- **永続化なし**: エージェント再起動時にメモリは永続化されない
- **長期保存なし**: ユーザーの好みやファクト抽出は実装されていない

## 将来の拡張

潜在的な改善には以下を含む：

1. **長期メモリ**: ユーザーの好みとセマンティックファクト抽出を実装
2. **クロスセッションメモリ**: 複数のセッション間でコンテキストを永続化
3. **メモリ分析**: 高度なメモリ使用量分析と最適化
4. **カスタム戦略**: カスタムメモリ抽出戦略のサポート

## 依存関係

- `bedrock-agentcore`: Amazon Bedrock AgentCore Memory クライアント
- `pyyaml`: 設定ファイル解析
- `uuid`: セッション ID 生成
- `datetime`: タイムスタンプ処理
- `boto3`: AWS サービス統合（間接的）

## セキュリティ

メモリ実装はセキュリティのベストプラクティスに従います：

- **IAM 統合**: 既存の AgentCore IAM ロールと権限を使用
- **データ暗号化**: 保存データに AWS サービス暗号化を活用
- **アクセス制御**: セッションとアクター識別に紐づいたメモリアクセス
- **プライバシー**: 機密会話データの永続的な保存なし