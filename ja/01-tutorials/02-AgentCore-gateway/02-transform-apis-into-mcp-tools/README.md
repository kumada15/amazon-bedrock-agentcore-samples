# Amazon Bedrock AgentCore Gateway を使用して API から MCP ツールを実装

## 概要
Bedrock AgentCore Gateway は、既存の API（OpenAPI と Smithy）をインフラやホスティングを管理することなく、フルマネージドの MCP サーバーに変換する方法を提供します。顧客は既存の OpenAPI と Smithy 仕様を持ち込んでツールに変換できます。Gateway はこれらすべてのツールに統一された Model Context Protocol（MCP）インターフェースを提供します。Gateway は、受信リクエストとターゲットリソースへのアウトバウンド接続の両方に対して安全なアクセス制御を確保するデュアル認証モデルを採用しています。このフレームワークは2つの主要コンポーネントで構成されています：Inbound Auth（ゲートウェイターゲットにアクセスしようとするユーザーを検証および認可）と Outbound Auth（API キー、OAuth トークン、AWS IAM ロールを使用して、認証されたユーザーに代わってゲートウェイがバックエンド API に安全に接続できるようにする）。

![How does it work](images/apis-into-mcp-gateway.png)


## 概念の定義

始める前に、Amazon Bedrock AgentCore Gateway を使い始めるためのいくつかの重要な概念を定義しましょう：
OpenAPI または Smithy API をグループ化して Bedrock AgentCore Gateway ターゲットを作成できます。ターゲットは、API を論理的にグループ化し、Amazon Core Gateway にアタッチするために使用するリソースです。

## API の Gateway ターゲットへのグループ化

以下は API を Gateway ターゲットにグループ化するためのベストプラクティスです：
* マイクロサービスパラダイムに適用可能なドメイン駆動設計の原則に似た、エージェントアプリケーションのビジネスドメインに基づいて MCP ツールをグループ化します。
* Gateway ターゲットのアウトバウンド認可には1つのリソース認証情報プロバイダーのみをアタッチできます。アウトバウンド認可者に基づいてツールをグループ化します。
* API のタイプ（OpenAPI、Smithy、または他のエンタープライズ API へのブリッジとして機能する AWS Lambda）に基づいて API をグループ化します。

![Grouping the API tools into targets](images/api-groups-targets.png)

## ベストプラクティス

1. ドキュメント品質ガイドライン
- 各 API エンドポイントとリソースに対して明確で説明的なサマリーを書く
- 目的と機能を説明する自然言語の説明を使用する
- 説明に実際のユースケースを含める
- 必要な場合を除き、技術的な専門用語を避ける
- ドキュメント全体で一貫した用語を確保する

2. スキーマドキュメント
- すべてのフィールドに詳細な説明を提供する
- フィールドの制約と検証ルールを含める
- データ型を正確にドキュメント化する
- 複雑なデータ構造の例を追加する
- 異なるスキーマ間の関係を説明する

3. OpenAPI 仕様のベストプラクティス
- OpenAPI リンターを使用して仕様を検証する
- 適切なセマンティックバージョニングを確保する
- 完全なリクエスト/レスポンス例を含める
- エラーレスポンスとコードをドキュメント化する
- セキュリティスキーム定義を追加する

4. ツール検索の最適化
- 説明に関連キーワードを自然に含める
- 各 API をいつ使用するかのコンテキストを提供する
- 代替アプローチや関連エンドポイントをドキュメント化する
- ビジネスドメインの用語を含める

5. API 抽出ガイドライン
- エージェントタスクに必要なコア機能を特定する
- ユースケースに基づいてフォーカスされた API サブセットを作成する
- 抽出された API 間のセマンティック関係を維持する
- セキュリティ定義と共通スキーマを保持する
- 抽出されたコンポーネント間の依存関係をドキュメント化する

6. モノリシック API 抽出プロセス：
- 完全な OpenAPI 仕様をレビューする
- エージェントのユースケースを特定のエンドポイントと認証要件にマッピングする
- 関連するパスとスキーマを抽出する
- コンポーネントの依存関係を維持する
- 抽出された仕様を検証する
- セマンティック検索の有効性をテストする

API が進化するにつれて、エージェントの品質と正確性を維持するために、ドキュメントを定期的にレビューおよび更新することを忘れないでください。

## インバウンドおよびアウトバウンド認可
Bedrock AgentCore Gateway は、インバウンドおよびアウトバウンド認証を通じて安全な接続を提供します。インバウンド認証では、AgentCore Gateway が呼び出し時に渡された OAuth トークンを分析して、ゲートウェイ内のツールへのアクセスを許可または拒否するかを決定します。ツールが外部リソースへのアクセスを必要とする場合、AgentCore Gateway は API キー、IAM、または OAuth トークンを介したアウトバウンド認証を使用して、外部リソースへのアクセスを許可または拒否できます。

インバウンド認可フロー中、エージェントまたは MCP クライアントは OAuth アクセストークン（ユーザーの IdP から生成）を追加して AgentCore Gateway の MCP ツールを呼び出します。AgentCore Gateway は OAuth アクセストークンを検証し、インバウンド認可を実行します。

AgentCore Gateway で実行されているツールが外部リソースにアクセスする必要がある場合、OAuth は Gateway ターゲットのリソース認証情報プロバイダーを使用してダウンストリームリソースの認証情報を取得します。AgentCore Gateway はダウンストリーム API へのアクセスを取得するために、認可認証情報を呼び出し元に渡します。

![Secure access](../images/gateway_secure_access.png)

### チュートリアル詳細

| 情報                 | 詳細                                                      |
|:---------------------|:----------------------------------------------------------|
| チュートリアルタイプ  | インタラクティブ                                           |
| AgentCore コンポーネント | AgentCore Gateway、AgentCore Identity                   |
| エージェントフレームワーク | Strands Agents                                         |
| LLM モデル           | Anthropic Claude Haiku 4.5、Amazon Nova Pro               |
| チュートリアル構成    | AgentCore Gateway の作成と AgentCore Gateway の呼び出し    |
| チュートリアル分野    | クロスバーティカル                                         |
| 例の複雑さ           | 簡単                                                       |
| 使用 SDK             | boto3                                                      |

## チュートリアルアーキテクチャ

### チュートリアルの主な機能

* OpenAPI API を MCP ツールに変換
* Smithy モデルを MCP ツールに変換

### チュートリアル概要

これらのチュートリアルでは、以下の機能をカバーします：

- [OpenAPI を MCP ツールに変換](01-transform-openapi-into-mcp-tools)
- [Smithy モデルを MCP ツールに変換](02-transform-smithyapis-into-mcp-tools)

